<!DOCTYPE html>
<html>
<head>
  <title>Register Passkey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>Register Passkey</h1>
  <button id="register">Register with Face ID</button>
  <div id="status"></div>

  <script>
    function base64urlEncode(buf) {
      return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");
    }

    function base64ToUint8Array(base64) {
      const padding = "=".repeat((4 - base64.length % 4) % 4);
      const base64Fixed = (base64 + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64Fixed);
      return new Uint8Array([...rawData].map(c => c.charCodeAt(0)));
    }

    document.getElementById("register").onclick = async () => {
        const publicKey = {
          challenge: base64ToUint8Array("cHJlc2V0LWhhcmQtc2lnbg"), // "preset-hard-sign"
          rp: { name: "Locker", id: "f9873d033355.ngrok-free.app" },
          user: {
            id: base64ToUint8Array("dXNlcjEyMw"), // "user123"
            name: "testuser",
            displayName: "Test User"
          },
          pubKeyCredParams: [{ type: "public-key", alg: -7 }],
          authenticatorSelection: { userVerification: "preferred" },
          timeout: 60000,
          attestation: "none"
        };

        const cred = await navigator.credentials.create({ publicKey });
        const rawId = base64urlEncode(cred.rawId);

        document.getElementById("status").textContent = "✅ Registered. Sending ID to locker...";

        await fetch("https://f9873d033355.ngrok-free.app/store-credential", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ rawId })
        });

        document.getElementById("status").textContent = "✅ Credential saved!";
    };
  </script>
</body>
</html>
